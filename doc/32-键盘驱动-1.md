# 键盘驱动

## 控制LED状态

​	我们键盘上有三个亮起的状态灯，分别为SCROLL_LOCK，NUM_LOCK，以及CAPS_LOCK，后两个我们都比较熟悉了，一个是小数字键盘锁定以及大写锁定，而 SCROLL_LOCK 则是滚屏锁定，我们平常用的很少，至少我是没怎么关注过这个的，听说可以在阅读文档的时候打开来按上下移动的话，就是一次滚动一个屏幕。

​	这三个状态非常容易控制，看图。

![](./图片/30-8042键盘控制器的寄存器.png)

​	这张图我们上期视频就看过了，但是我们只使用了 **0x60** 缓冲区端口，我们接下来要关心的就是状态寄存器端口和控制寄存器端口了。

​	通过状态寄存器，我们可以读取当前键盘所处的状态，你没有听错，就这枚普普通通的键盘，也是存在不同的各种状态的，但我们在这里只需要关心以下的两个状态。



| 状态 | 说明                           |
| ---- | ------------------------------ |
| 0x01 | 字符按键按下时该状态位被设置   |
| 0x02 | 未准备接收字符时该状态位被设置 |

​	我们在设置 LED 的三个状态时，必须保证键盘不处于以上的两个状态，不然将会导致键盘忙而无法响应命令，最后失败，我们将会编写一个函数，用来等待键盘直到不忙，这样在我们设置 LED 状态时，我们就可以确保我们在键盘可接收一条命令的情况下了。

​	接下来，我们看看我们该如何发出更改 LED 状态的命令，这里也非常简单，但是比较复杂，需要分两步，首先我们先需要写一条字节 **0xED** 到输出缓冲区，然后*等到键盘控制器响应*后，再发送 LED 的状态即可，LED 的状态控制字节如下。

​	

| 状态字节       | 解释                    |
| -------------- | ----------------------- |
| 0x01(00000001) | SCROLL_LOCK 滚屏锁定    |
| 0x02(00000010) | NUM_LOCK 小数字键盘锁定 |
| 0x04(00000100) | CAPS_LOCK 大写锁定      |

​	有了以上的状态，我们就能轻而易举的设置我们想要的 LED 状态了！但不知道你发现没，上面的等到"键盘控制器响应"这个段落是斜体的，说明这步我们也不能落下，这里的实现和等待键盘空闲的实现是类似的，我们可以等待键盘执行最后一条发出的指令直至响应为止，这一步理论是一样的，但是有一个不同点，就是我们不再是读取状态寄存器的值来判断是否响应，而是直接判断输出缓冲区的值，当输出缓冲区返回了扫描码 **0xFA(250)** 时，说明键盘控制器成功的响应了最后的命令。

​	









